name: Build and Push to JFrog Artifactory

on:
  push:
    branches: [main]
    tags: ['v*']

env:
  IMAGE_NAME: docker-artifactory-demo
  REGISTRY: ${{ secrets.ARTIFACTORY_URL }}
  REPO: ${{ secrets.ARTIFACTORY_REPO }}

jobs:
  docker-build-push:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Get the code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Determine image tag
      - name: Set image tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="${GITHUB_SHA::7}"
          fi
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"

      # Step 3: Build the Docker image
      - name: Build Docker image
        run: |
          echo "Building image: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.TAG }}"
          docker build -t ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.TAG }} .
          docker tag ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.TAG }} ${{ env.IMAGE_NAME }}:latest
          echo "✓ Build complete"

      # Step 4: Login to Artifactory
      - name: Login to JFrog Artifactory
        run: |
          echo "Logging in to ${{ env.REGISTRY }}..."
          echo "${{ secrets.ARTIFACTORY_TOKEN }}" | docker login ${{ env.REGISTRY }} \
            --username ${{ secrets.ARTIFACTORY_USER }} \
            --password-stdin
          echo "✓ Login successful"

      # Step 5: Tag images for Artifactory
      - name: Tag images for Artifactory
        run: |
          FULL_IMAGE="${{ env.REGISTRY }}/${{ env.REPO }}/${{ env.IMAGE_NAME }}"
          echo "Tagging for: $FULL_IMAGE"
          
          docker tag ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.TAG }} ${FULL_IMAGE}:${{ steps.tag.outputs.TAG }}
          docker tag ${{ env.IMAGE_NAME }}:latest ${FULL_IMAGE}:latest
          
          echo "✓ Tagged: ${FULL_IMAGE}:${{ steps.tag.outputs.TAG }}"
          echo "✓ Tagged: ${FULL_IMAGE}:latest"

      # Step 6: Push to Artifactory
      - name: Push to Artifactory
        run: |
          FULL_IMAGE="${{ env.REGISTRY }}/${{ env.REPO }}/${{ env.IMAGE_NAME }}"
          
          echo "Pushing ${FULL_IMAGE}:${{ steps.tag.outputs.TAG }}..."
          docker push ${FULL_IMAGE}:${{ steps.tag.outputs.TAG }}
          
          echo "Pushing ${FULL_IMAGE}:latest..."
          docker push ${FULL_IMAGE}:latest
          
          echo ""
          echo "✅ Successfully pushed to Artifactory!"
          echo "   Image: ${FULL_IMAGE}:${{ steps.tag.outputs.TAG }}"
          echo "   Image: ${FULL_IMAGE}:latest"
